<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>bcbio-nextgen-vm on Windows Azure : Troubleshooting - Elasticluster</title>
        <meta name="description" content="A brief documentation for bcbio-nextgen-vm on Windows Azure">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/docs-azure-bcbiovm/css/syntax.css">
        <link rel="stylesheet" href="/docs-azure-bcbiovm/css/main.css">
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <h4><a class="brand" href="/docs-azure-bcbiovm/">bcbio-nextgen-vm on Windows Azure</a>
    <small>A brief documentation for bcbio-nextgen-vm on Windows Azure</small>
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-2">
                        <ul class="nav nav-list">
    <li><a href="/docs-azure-bcbiovm/">Home</a></li>
    
        
        

        
            
                <li class="nav-header">Documentation</li>
            
            <li><a href="/docs-azure-bcbiovm/doc/environment-setup.html">Environment Setup</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/install-bcbio-nextgen-vm.html">Install bcbio-nextgen-vm</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/setup-docker.html">Setup Docker</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/setup-azure-environment.html">Setup Windows Azure environment</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/bcbio-cluster.html">bcbio cluster on Windows Azure</a></li>
        
    
        
        

        
            
                <li class="nav-header">Troubleshooting</li>
            
            <li><a href="/docs-azure-bcbiovm/troubleshooting/elasticluster.html">Troubleshooting - Elasticluster</a></li>
        
    
</ul>

                    </div>

                    <div id="content" class="col-sm-10">
                        <div class="page-header">
    <h2>Troubleshooting - Elasticluster
        
    </h2>
</div>

<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="the-server-encountered-an-internal-error">The server encountered an internal error</h3>

<p>The curent version of elasticluster for Azure doesn&#39;t have a friendly error reporting mechanism. If the following errors continue to appear and the attempt number is bigger then 25 is possible to have some misconfigurations in the azure.conf file. </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio-compute002 (attempt 1 of 50): async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio-compute002 (attempt 2 of 50): async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio-compute002 (attempt 3 of 50): async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio-compute002 (attempt 4 of 50): async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio-compute002 (attempt 5 of 50): async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio-compute002 (attempt 6 of 50): async operation failed: The server encountered an internal error. Please retry the request.
</code></pre></div>
<h3 id="bcbio-pickle-not-found">bcbio.pickle not found</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>bcbio_vm.py azure cluster stop --cluster bcbio
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">[DEBUG]: Run elasticluster command: [&#39;elasticluster&#39;, &#39;--storage&#39;, &#39;/home/alex/.bcbio/elasticluster/storage&#39;, &#39;--config&#39;, &#39;/home/alex/.bcbio/elasticluster/azure.config&#39;, &#39;stop&#39;, &#39;bcbio&#39;]
[ERROR]: gc3.elasticluster:Stopping cluster bcbio: Storage file /home/alex/.bcbio/elasticluster/storage/bcbio.pickle not found

bcbiovm.client.base - [INFO]: Execution of command Stop ends with success. (0)
</code></pre></div>
<p>The elasticluster failed to cleanup the environment.</p>

<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/elastic-cluster-resources.png" alt="Elasticluster resources"></p>

<p>In order to cleanup the environment you will need to follow this steps:</p>

<h4 id="delete-all-the-bcbio_vm-virtual-machines">Delete all the bcbio_vm*** virtual machines**</h4>

<p>-&gt; <img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/azure-delete-vm-1.png" alt="Delete bcbio virtual machine"> &lt;-</p>

<p>-&gt; <img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/azure-delete-vm-1.png" alt="Delete bcbio virtual machine"> &lt;-</p>

<h4 id="delete-the-storage-account">Delete the Storage Account</h4>

<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/delete-storage-account.png" alt="Delete the Storage Account"></p>

<h4 id="delete-the-cloud-service">Delete the Cloud Service</h4>

<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/delete-cloud-service.png" alt="Delete the Cloud Service"></p>

<h4 id="delete-the-virtual-network">Delete the Virtual Network</h4>

<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/delete-virtual-network.png" alt="Delete the Virtual Network"></p>

<h3 id="typeerror-expected-string-or-buffer">TypeError: expected string or buffer</h3>
<div class="highlight"><pre><code class="language-text" data-lang="text">INFO:gc3.elasticluster:_start_node: node has been started
INFO:gc3.elasticluster:_start_node: node has been started
INFO:gc3.elasticluster:_start_node: node has been started
Traceback (most recent call last):
  File &quot;/home/alex/miniconda/envs/_test/bin/bcbio_vm.py&quot;, line 4, in &lt;module&gt;
    __import__(&#39;pkg_resources&#39;).run_script(&#39;bcbio-nextgen-vm==0.1.0a0&#39;, &#39;bcbio_vm.py&#39;)
  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/setuptools-18.4-py2.7.egg/pkg_resources/__init__.py&quot;, line 735, in run_script

  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/setuptools-18.4-py2.7.egg/pkg_resources/__init__.py&quot;, line 1659, in run_script

  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/bcbio_nextgen_vm-0.1.0a0-py2.7.egg/EGG-INFO/scripts/bcbio_vm.py&quot;, line 89, in &lt;module&gt;

  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/bcbio_nextgen_vm-0.1.0a0-py2.7.egg/EGG-INFO/scripts/bcbio_vm.py&quot;, line 85, in main

  File &quot;build/bdist.linux-x86_64/egg/bcbiovm/client/base.py&quot;, line 70, in run
  File &quot;build/bdist.linux-x86_64/egg/bcbiovm/client/base.py&quot;, line 335, in work
  File &quot;build/bdist.linux-x86_64/egg/bcbiovm/client/base.py&quot;, line 70, in run
  File &quot;build/bdist.linux-x86_64/egg/bcbiovm/client/commands/provider/cluster.py&quot;, line 185, in work
  File &quot;build/bdist.linux-x86_64/egg/bcbiovm/provider/base.py&quot;, line 153, in start
  File &quot;build/bdist.linux-x86_64/egg/bcbiovm/common/cluster.py&quot;, line 161, in start
  File &quot;build/bdist.linux-x86_64/egg/bcbiovm/common/cluster.py&quot;, line 144, in execute
  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/main.py&quot;, line 181, in main
    app.run()
  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/cli/app.py&quot;, line 245, in run
    return self.post_run(returned)
  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/cli/app.py&quot;, line 241, in run
    returned = self.main(*args)
  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/main.py&quot;, line 169, in main
    return self.params.func()
  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/subcommands.py&quot;, line 71, in __call__
    return self.execute()
  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/subcommands.py&quot;, line 190, in execute
    cluster.start(min_nodes=min_nodes)
  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/cluster.py&quot;, line 415, in start
    keys, node.instance_id, node.ips)
  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/cluster.py&quot;, line 649, in _get_ssh_key_from_console_output
    r&#39;\1&#39;, console_output, flags=re.DOTALL).strip()
  File &quot;/home/alex/miniconda/envs/_test/lib/python2.7/re.py&quot;, line 155, in sub
    return _compile(pattern, flags).sub(repl, string, count)
TypeError: expected string or buffer
</code></pre></div>
<p>Information related to keys from <a href="https://github.com/chapmanb/elasticluster/blob/bcbio/README-AZURE.rst">Elasticluster for Azure documentation</a>:</p>

<p>6. You&#39;ll need a keypair to access the virtual machines during provisioning, and later via ssh. For now, you should create a private key file that matches your management cert, like this:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">  ~ <span class="nv">$ </span>openssl rsa -in managementCert.pem -out managementCert.key
</code></pre></div>
<p>SSH is picky about ownership/permissions on key files. Make sure that yours look like this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">  ~ $  ls -l ~/.ssh
  [...]
  -rw------- 1 my_user_name my_user_name  797 May  3 18:00 managementCert.cer
</code></pre></div>
<p>Use these commands if needed on the .pem, .cer, and .key files:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">  <span class="c"># replace &#39;my_user_name&#39; with your username - you knew that</span>
  ~ <span class="nv">$ </span>sudo chown my_user_name:my_user_name ~/.ssh/managementCert.pem
  ~ <span class="nv">$ </span>sudo chmod <span class="m">600</span> ~/.ssh/managementCert.pem
  <span class="c"># make sure you do this to all 3 files!</span>
</code></pre></div>
<p>(<strong>Note</strong>:  access to a specific virtual machine using a keypair that is not also an Azure management keypair doesn&#39;t work at present, but is an open work item.)</p>

<h4 id="step1-replace-ssh-with-home-user-ssh">Step1. Replace <code>~/.ssh</code> with <code>/home/user/.ssh</code></h4>
<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="k">[cloud/azure-cloud]</span>
<span class="na">provider</span> <span class="o">=</span> <span class="s">azure</span>
<span class="na">subscription_id</span> <span class="o">=</span> <span class="s">[secret]</span>
<span class="na">certificate</span> <span class="o">=</span> <span class="s">/home/alex/.ssh/managementCert.pem</span>

<span class="k">[login/azure-login]</span>
<span class="na">image_user</span> <span class="o">=</span> <span class="s">ubuntu</span>
<span class="na">image_user_sudo</span> <span class="o">=</span> <span class="s">root</span>
<span class="na">image_sudo</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">user_key_name</span> <span class="o">=</span> <span class="s">az_ec_key</span>
<span class="na">user_key_private</span> <span class="o">=</span> <span class="s">/home/alex/.ssh/managementCert.key</span>
<span class="na">user_key_public</span> <span class="o">=</span> <span class="s">/home/alex/.ssh/managementCert.pem</span>

<span class="k">[setup/ansible]</span>
<span class="na">provider</span> <span class="o">=</span> <span class="s">ansible</span>
<span class="na">frontend_groups</span> <span class="o">=</span> <span class="s">common</span>
<span class="na">compute_groups</span> <span class="o">=</span> <span class="s">clients</span>

<span class="k">[setup/ansible-slurm]</span>
<span class="na">provider</span> <span class="o">=</span> <span class="s">ansible</span>
<span class="na">frontend_groups</span> <span class="o">=</span> <span class="s">slurm_master</span>
<span class="na">compute_groups</span> <span class="o">=</span> <span class="s">slurm_clients</span>
<span class="na">global_var_slurm_selecttype</span> <span class="o">=</span> <span class="s">select/cons_res</span>
<span class="na">global_var_slurm_selecttypeparameters</span> <span class="o">=</span> <span class="s">CR_Core_Memory</span>

<span class="k">[cluster/bcbio]</span>
<span class="na">cloud</span> <span class="o">=</span> <span class="s">azure-cloud</span>
<span class="na">login</span> <span class="o">=</span> <span class="s">azure-login</span>
<span class="na">ssh_to</span> <span class="o">=</span> <span class="s">frontend</span>
<span class="na">ssh_hostkeys_from_console_output</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">security_group</span> <span class="o">=</span> <span class="s">default</span>
<span class="na">setup_provider</span> <span class="o">=</span> <span class="s">ansible-slurm</span>
<span class="na">frontend_nodes</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">compute_nodes</span> <span class="o">=</span> <span class="s">3</span>
<span class="na">image_id</span> <span class="o">=</span> <span class="s">b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-14_04-LTS-amd64-server-20140414-en-us-30GB</span>
<span class="na">root_volume_size</span> <span class="o">=</span> <span class="s">20</span>
<span class="na">flavor</span> <span class="o">=</span> <span class="s">Small</span>
<span class="na">location</span> <span class="o">=</span> <span class="s">East US</span>
<span class="na">wait_timeout</span> <span class="o">=</span> <span class="s">600</span>
<span class="na">base_name</span> <span class="o">=</span> <span class="s">bcbio</span>
<span class="na">global_var_ansible_ssh_host_key_dsa_public</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

<span class="k">[cluster/bcbio/frontend]</span>
<span class="na">flavor</span> <span class="o">=</span> <span class="s">Small</span>
<span class="na">encrypted_volume_size</span> <span class="o">=</span> <span class="s">20</span>
<span class="na">encrypted_volume_type</span> <span class="o">=</span> <span class="s">io1</span>
<span class="na">encrypted_volume_iops</span> <span class="o">=</span> <span class="s">600</span>
</code></pre></div>
<h4 id="step2-check-keys-permissions-in-home-user-ssh">Step2. Check keys permissions in <code>/home/user/.ssh</code></h4>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>ls -la
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">total 116
drwx------  3 alex alex  4096 Nov  7 13:55 .
drwx------ 87 alex alex 20480 Nov 13 15:45 ..
-rw-r--r--  1 alex alex  1522 Nov  7 10:49 config
drwx------  2 alex alex  4096 Apr  6  2015 keys
-rw-------  1 alex alex 11574 Nov 12 22:22 known_hosts
-rw-------  1 alex alex 11352 Nov  7 10:51 known_hosts.old
-rw-------  1 alex alex   989 Oct 26 15:00 managementCert.cer
-rw-------  1 alex alex  1675 Oct 26 15:39 managementCert.key
-rw-------  1 alex alex  3099 Oct 26 15:00 managementCert.pem
</code></pre></div>
<h4 id="step3-update-keys-permissions">Step3. Update keys permissions</h4>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>chmod <span class="m">600</span> managementCert.cer
~ <span class="nv">$ </span>chmod <span class="m">600</span> managementCert.key
~ <span class="nv">$ </span>chmod <span class="m">600</span> managementCert.pem
</code></pre></div>
<p><strong>Note</strong>: For the current issue doesn&#39;t exist a fix yet.</p>


                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/alexandrucoman/docs-azure-bcbiovm">bcbio-nextgen-vm on Windows Azure</a>

                </div>
            </div>
        </div>
        
    </body>
</html>
