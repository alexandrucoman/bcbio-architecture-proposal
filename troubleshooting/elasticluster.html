<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>bcbio-nextgen-vm on Windows Azure : Troubleshooting - Elasticluster</title>
        <meta name="description" content="A brief documentation for bcbio-nextgen-vm on Windows Azure">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/docs-azure-bcbiovm/css/syntax.css">
        <link rel="stylesheet" href="/docs-azure-bcbiovm/css/main.css">
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <h4><a class="brand" href="/docs-azure-bcbiovm/">bcbio-nextgen-vm on Windows Azure</a>
    <small>A brief documentation for bcbio-nextgen-vm on Windows Azure</small>
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-2">
                        <ul class="nav nav-list">
    <li><a href="/docs-azure-bcbiovm/">Home</a></li>
    
        
        

        
            
                <li class="nav-header">Documentation</li>
            
            <li><a href="/docs-azure-bcbiovm/doc/environment-setup.html">Environment Setup</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/install-bcbio-nextgen-vm.html">Install bcbio-nextgen-vm</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/setup-docker.html">Setup Docker</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/setup-azure-environment.html">Setup Windows Azure environment</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/bcbio-cluster.html">bcbio cluster on Windows Azure</a></li>
        
    
        
        

        
            
                <li class="nav-header">Troubleshooting</li>
            
            <li><a href="/docs-azure-bcbiovm/troubleshooting/elasticluster.html">Troubleshooting - Elasticluster</a></li>
        
    
</ul>

                    </div>

                    <div id="content" class="col-sm-10">
                        <div class="page-header">
    <h2>Troubleshooting - Elasticluster
        
    </h2>
</div>

<h2 id="the-server-encountered-an-internal-error">The server encountered an internal error</h2>

<p>The curent version of elasticluster for Azure doesn&#39;t have a friendly error reporting mechanism. If the following errors continue to appear and the attempt number is bigger then 25 is possible to have some misconfigurations in the azure.conf file. </p>
<div class="highlight"><pre><code class="language-vim" data-lang="vim">ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio<span class="p">-</span>compute002 <span class="p">(</span>attempt <span class="m">1</span> of <span class="m">50</span><span class="p">)</span>: async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio<span class="p">-</span>compute002 <span class="p">(</span>attempt <span class="m">2</span> of <span class="m">50</span><span class="p">)</span>: async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio<span class="p">-</span>compute002 <span class="p">(</span>attempt <span class="m">3</span> of <span class="m">50</span><span class="p">)</span>: async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio<span class="p">-</span>compute002 <span class="p">(</span>attempt <span class="m">4</span> of <span class="m">50</span><span class="p">)</span>: async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio<span class="p">-</span>compute002 <span class="p">(</span>attempt <span class="m">5</span> of <span class="m">50</span><span class="p">)</span>: async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:async operation failed: The server encountered an internal error. Please retry the request.
ERROR:gc3.elasticluster:error creating vm bcbio_vm0000_bcbio<span class="p">-</span>compute002 <span class="p">(</span>attempt <span class="m">6</span> of <span class="m">50</span><span class="p">)</span>: async operation failed: The server encountered an internal error. Please retry the request.
</code></pre></div>
<h2 id="bcbio-pickle-not-found">bcbio.pickle not found</h2>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>bcbio_vm.py azure cluster stop --cluster bcbio
</code></pre></div><div class="highlight"><pre><code class="language-vim" data-lang="vim">[DEBUG]: Run elasticluster command: [<span class="s1">&#39;elasticluster&#39;</span><span class="p">,</span> <span class="s1">&#39;--storage&#39;</span><span class="p">,</span> <span class="s1">&#39;/home/alex/.bcbio/elasticluster/storage&#39;</span><span class="p">,</span> <span class="s1">&#39;--config&#39;</span><span class="p">,</span> <span class="s1">&#39;/home/alex/.bcbio/elasticluster/azure.config&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;bcbio&#39;</span>]
[ERROR]: gc3.elasticluster:Stopping cluster bcbio: Storage <span class="k">file</span> <span class="sr">/home/</span>alex<span class="sr">/.bcbio/</span>elasticluster<span class="sr">/storage/</span>bcbio.pickle not found

bcbiovm.client.base <span class="p">-</span> [INFO]: Execution of command Stop ends with success. <span class="p">(</span><span class="m">0</span><span class="p">)</span>
</code></pre></div>
<p>The elasticluster failed to cleanup the environment.</p>

<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/elastic-cluster-resources.png" alt="Elasticluster resources">{: .center-image }</p>

<p>In order to cleanup the environment you will need to follow this steps:</p>

<h3 id="delete-all-the-bcbio_vm-virtual-machines">Delete all the bcbio_vm*** virtual machines**</h3>

<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/azure-delete-vm-1.png" alt="Delete bcbio virtual machine">{: .center-image }</p>

<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/azure-delete-vm-1.png" alt="Delete bcbio virtual machine">{: .center-image }</p>

<h3 id="delete-the-storage-account">Delete the Storage Account</h3>

<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/delete-storage-account.png" alt="Delete the Storage Account">{: .center-image }</p>

<h3 id="delete-the-cloud-service">Delete the Cloud Service</h3>

<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/delete-cloud-service.png" alt="Delete the Cloud Service">{: .center-image }</p>

<h3 id="delete-the-virtual-network">Delete the Virtual Network</h3>

<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/delete-virtual-network.png" alt="Delete the Virtual Network">{: .center-image }</p>

<h2 id="typeerror-expected-string-or-buffer">TypeError: expected string or buffer</h2>
<div class="highlight"><pre><code class="language-vim" data-lang="vim">INFO:gc3.elasticluster:_start_node: node has been started
INFO:gc3.elasticluster:_start_node: node has been started
INFO:gc3.elasticluster:_start_node: node has been started
Traceback <span class="p">(</span>most recent <span class="k">call</span> last<span class="p">)</span>:
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/bin/bcbio_vm.py&quot;</span><span class="p">,</span> line <span class="m">4</span><span class="p">,</span> <span class="k">in</span> <span class="p">&lt;</span>module<span class="p">&gt;</span>
    __import__<span class="p">(</span><span class="s1">&#39;pkg_resources&#39;</span><span class="p">)</span>.run_script<span class="p">(</span><span class="s1">&#39;bcbio-nextgen-vm==0.1.0a0&#39;</span><span class="p">,</span> <span class="s1">&#39;bcbio_vm.py&#39;</span><span class="p">)</span>
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/setuptools-18.4-py2.7.egg/pkg_resources/__init__.py&quot;</span><span class="p">,</span> line <span class="m">735</span><span class="p">,</span> <span class="k">in</span> run_script

  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/setuptools-18.4-py2.7.egg/pkg_resources/__init__.py&quot;</span><span class="p">,</span> line <span class="m">1659</span><span class="p">,</span> <span class="k">in</span> run_script

  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/bcbio_nextgen_vm-0.1.0a0-py2.7.egg/EGG-INFO/scripts/bcbio_vm.py&quot;</span><span class="p">,</span> line <span class="m">89</span><span class="p">,</span> <span class="k">in</span> <span class="p">&lt;</span>module<span class="p">&gt;</span>

  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/bcbio_nextgen_vm-0.1.0a0-py2.7.egg/EGG-INFO/scripts/bcbio_vm.py&quot;</span><span class="p">,</span> line <span class="m">85</span><span class="p">,</span> <span class="k">in</span> <span class="k">main</span>

  File <span class="s2">&quot;build/bdist.linux-x86_64/egg/bcbiovm/client/base.py&quot;</span><span class="p">,</span> line <span class="m">70</span><span class="p">,</span> <span class="k">in</span> run
  File <span class="s2">&quot;build/bdist.linux-x86_64/egg/bcbiovm/client/base.py&quot;</span><span class="p">,</span> line <span class="m">335</span><span class="p">,</span> <span class="k">in</span> work
  File <span class="s2">&quot;build/bdist.linux-x86_64/egg/bcbiovm/client/base.py&quot;</span><span class="p">,</span> line <span class="m">70</span><span class="p">,</span> <span class="k">in</span> run
  File <span class="s2">&quot;build/bdist.linux-x86_64/egg/bcbiovm/client/commands/provider/cluster.py&quot;</span><span class="p">,</span> line <span class="m">185</span><span class="p">,</span> <span class="k">in</span> work
  File <span class="s2">&quot;build/bdist.linux-x86_64/egg/bcbiovm/provider/base.py&quot;</span><span class="p">,</span> line <span class="m">153</span><span class="p">,</span> <span class="k">in</span> <span class="k">start</span>
  File <span class="s2">&quot;build/bdist.linux-x86_64/egg/bcbiovm/common/cluster.py&quot;</span><span class="p">,</span> line <span class="m">161</span><span class="p">,</span> <span class="k">in</span> <span class="k">start</span>
  File <span class="s2">&quot;build/bdist.linux-x86_64/egg/bcbiovm/common/cluster.py&quot;</span><span class="p">,</span> line <span class="m">144</span><span class="p">,</span> <span class="k">in</span> execute
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/main.py&quot;</span><span class="p">,</span> line <span class="m">181</span><span class="p">,</span> <span class="k">in</span> <span class="k">main</span>
    app.run<span class="p">()</span>
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/cli/app.py&quot;</span><span class="p">,</span> line <span class="m">245</span><span class="p">,</span> <span class="k">in</span> run
    <span class="k">return</span> self.post_run<span class="p">(</span>returned<span class="p">)</span>
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/cli/app.py&quot;</span><span class="p">,</span> line <span class="m">241</span><span class="p">,</span> <span class="k">in</span> run
    returned <span class="p">=</span> self.<span class="k">main</span><span class="p">(</span>*args<span class="p">)</span>
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/main.py&quot;</span><span class="p">,</span> line <span class="m">169</span><span class="p">,</span> <span class="k">in</span> <span class="k">main</span>
    <span class="k">return</span> self.params.func<span class="p">()</span>
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/subcommands.py&quot;</span><span class="p">,</span> line <span class="m">71</span><span class="p">,</span> <span class="k">in</span> __call__
    <span class="k">return</span> self.execute<span class="p">()</span>
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/subcommands.py&quot;</span><span class="p">,</span> line <span class="m">190</span><span class="p">,</span> <span class="k">in</span> execute
    cluster.<span class="k">start</span><span class="p">(</span>min_nodes<span class="p">=</span>min_nodes<span class="p">)</span>
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/cluster.py&quot;</span><span class="p">,</span> line <span class="m">415</span><span class="p">,</span> <span class="k">in</span> <span class="k">start</span>
    keys<span class="p">,</span> node.instance_id<span class="p">,</span> node.ips<span class="p">)</span>
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/site-packages/elasticluster/cluster.py&quot;</span><span class="p">,</span> line <span class="m">649</span><span class="p">,</span> <span class="k">in</span> _get_ssh_key_from_console_output
    <span class="k">r</span><span class="s1">&#39;\1&#39;</span><span class="p">,</span> console_output<span class="p">,</span> flags<span class="p">=</span><span class="k">re</span>.DOTALL<span class="p">)</span>.strip<span class="p">()</span>
  File <span class="s2">&quot;/home/alex/miniconda/envs/_test/lib/python2.7/re.py&quot;</span><span class="p">,</span> line <span class="m">155</span><span class="p">,</span> <span class="k">in</span> <span class="k">sub</span>
    <span class="k">return</span> _compile<span class="p">(</span>pattern<span class="p">,</span> flags<span class="p">)</span>.<span class="k">sub</span><span class="p">(</span>repl<span class="p">,</span> string<span class="p">,</span> <span class="k">count</span><span class="p">)</span>
TypeError: expected string or buffer
</code></pre></div>
<p>Information related to keys from <a href="https://github.com/chapmanb/elasticluster/blob/bcbio/README-AZURE.rst">Elasticluster for Azure documentation</a>:</p>

<hr>

<p>6. You&#39;ll need a keypair to access the virtual machines during provisioning, and later via ssh. For now, you should create a private key file that matches your management cert, like this:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>openssl rsa -in managementCert.pem -out managementCert.key
</code></pre></div>
<p>SSH is picky about ownership/permissions on key files. Make sure that yours look like this:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span> ls -l ~/.ssh
<span class="o">[</span>...<span class="o">]</span>
-rw------- <span class="m">1</span> my_user_name my_user_name  <span class="m">797</span> May  <span class="m">3</span> 18:00 managementCert.cer
</code></pre></div>
<p>Use these commands if needed on the .pem, .cer, and .key files:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># replace &#39;my_user_name&#39; with your username - you knew that</span>
~ <span class="nv">$ </span>sudo chown my_user_name:my_user_name ~/.ssh/managementCert.pem
~ <span class="nv">$ </span>sudo chmod <span class="m">600</span> ~/.ssh/managementCert.pem
<span class="c"># make sure you do this to all 3 files!</span>
</code></pre></div>
<p>(<strong>Note</strong>:  access to a specific virtual machine using a keypair that is not also an Azure management keypair doesn&#39;t work at present, but is an open work item.)</p>

<hr>

<h3 id="step1-replace-ssh-with-home-user-ssh">Step1. Replace <code>~/.ssh</code> with <code>/home/user/.ssh</code></h3>
<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="k">[cloud/azure-cloud]</span>
<span class="na">provider</span> <span class="o">=</span> <span class="s">azure</span>
<span class="na">subscription_id</span> <span class="o">=</span> <span class="s">[secret]</span>
<span class="na">certificate</span> <span class="o">=</span> <span class="s">/home/alex/.ssh/managementCert.pem</span>

<span class="k">[login/azure-login]</span>
<span class="na">image_user</span> <span class="o">=</span> <span class="s">ubuntu</span>
<span class="na">image_user_sudo</span> <span class="o">=</span> <span class="s">root</span>
<span class="na">image_sudo</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">user_key_name</span> <span class="o">=</span> <span class="s">az_ec_key</span>
<span class="na">user_key_private</span> <span class="o">=</span> <span class="s">/home/alex/.ssh/managementCert.key</span>
<span class="na">user_key_public</span> <span class="o">=</span> <span class="s">/home/alex/.ssh/managementCert.pem</span>

<span class="k">[setup/ansible]</span>
<span class="na">provider</span> <span class="o">=</span> <span class="s">ansible</span>
<span class="na">frontend_groups</span> <span class="o">=</span> <span class="s">common</span>
<span class="na">compute_groups</span> <span class="o">=</span> <span class="s">clients</span>

<span class="k">[setup/ansible-slurm]</span>
<span class="na">provider</span> <span class="o">=</span> <span class="s">ansible</span>
<span class="na">frontend_groups</span> <span class="o">=</span> <span class="s">slurm_master</span>
<span class="na">compute_groups</span> <span class="o">=</span> <span class="s">slurm_clients</span>
<span class="na">global_var_slurm_selecttype</span> <span class="o">=</span> <span class="s">select/cons_res</span>
<span class="na">global_var_slurm_selecttypeparameters</span> <span class="o">=</span> <span class="s">CR_Core_Memory</span>

<span class="k">[cluster/bcbio]</span>
<span class="na">cloud</span> <span class="o">=</span> <span class="s">azure-cloud</span>
<span class="na">login</span> <span class="o">=</span> <span class="s">azure-login</span>
<span class="na">ssh_to</span> <span class="o">=</span> <span class="s">frontend</span>
<span class="na">ssh_hostkeys_from_console_output</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">security_group</span> <span class="o">=</span> <span class="s">default</span>
<span class="na">setup_provider</span> <span class="o">=</span> <span class="s">ansible-slurm</span>
<span class="na">frontend_nodes</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">compute_nodes</span> <span class="o">=</span> <span class="s">3</span>
<span class="na">image_id</span> <span class="o">=</span> <span class="s">b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-14_04-LTS-amd64-server-20140414-en-us-30GB</span>
<span class="na">root_volume_size</span> <span class="o">=</span> <span class="s">20</span>
<span class="na">flavor</span> <span class="o">=</span> <span class="s">Small</span>
<span class="na">location</span> <span class="o">=</span> <span class="s">East US</span>
<span class="na">wait_timeout</span> <span class="o">=</span> <span class="s">600</span>
<span class="na">base_name</span> <span class="o">=</span> <span class="s">bcbio</span>
<span class="na">global_var_ansible_ssh_host_key_dsa_public</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

<span class="k">[cluster/bcbio/frontend]</span>
<span class="na">flavor</span> <span class="o">=</span> <span class="s">Small</span>
<span class="na">encrypted_volume_size</span> <span class="o">=</span> <span class="s">20</span>
<span class="na">encrypted_volume_type</span> <span class="o">=</span> <span class="s">io1</span>
<span class="na">encrypted_volume_iops</span> <span class="o">=</span> <span class="s">600</span>
</code></pre></div>
<h3 id="step2-check-keys-permissions-in-home-user-ssh">Step2. Check keys permissions in <code>/home/user/.ssh</code></h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>ls -la
</code></pre></div><div class="highlight"><pre><code class="language-vim" data-lang="vim">total <span class="m">116</span>
drwx<span class="p">------</span>  <span class="m">3</span> alex alex  <span class="m">4096</span> Nov  <span class="m">7</span> <span class="m">13</span>:<span class="m">55</span> .
drwx<span class="p">------</span> <span class="m">87</span> alex alex <span class="m">20480</span> Nov <span class="m">13</span> <span class="m">15</span>:<span class="m">45</span> ..
<span class="p">-</span>rw<span class="p">-</span><span class="k">r</span><span class="p">--</span><span class="k">r</span><span class="p">--</span>  <span class="m">1</span> alex alex  <span class="m">1522</span> Nov  <span class="m">7</span> <span class="m">10</span>:<span class="m">49</span> config
drwx<span class="p">------</span>  <span class="m">2</span> alex alex  <span class="m">4096</span> Apr  <span class="m">6</span>  <span class="m">2015</span> keys
<span class="p">-</span>rw<span class="p">-------</span>  <span class="m">1</span> alex alex <span class="m">11574</span> Nov <span class="m">12</span> <span class="m">22</span>:<span class="m">22</span> known_hosts
<span class="p">-</span>rw<span class="p">-------</span>  <span class="m">1</span> alex alex <span class="m">11352</span> Nov  <span class="m">7</span> <span class="m">10</span>:<span class="m">51</span> known_hosts.<span class="k">old</span>
<span class="p">-</span>rw<span class="p">-------</span>  <span class="m">1</span> alex alex   <span class="m">989</span> Oct <span class="m">26</span> <span class="m">15</span>:<span class="m">00</span> managementCert.cer
<span class="p">-</span>rw<span class="p">-------</span>  <span class="m">1</span> alex alex  <span class="m">1675</span> Oct <span class="m">26</span> <span class="m">15</span>:<span class="m">39</span> managementCert.<span class="nb">key</span>
<span class="p">-</span>rw<span class="p">-------</span>  <span class="m">1</span> alex alex  <span class="m">3099</span> Oct <span class="m">26</span> <span class="m">15</span>:<span class="m">00</span> managementCert.pem
</code></pre></div>
<h3 id="step3-update-keys-permissions">Step3. Update keys permissions</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>chmod <span class="m">600</span> managementCert.cer
~ <span class="nv">$ </span>chmod <span class="m">600</span> managementCert.key
~ <span class="nv">$ </span>chmod <span class="m">600</span> managementCert.pem
</code></pre></div>
<p><strong>Note</strong>: For the current issue doesn&#39;t exist a fix yet.</p>


                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/alexandrucoman/docs-azure-bcbiovm">bcbio-nextgen-vm on Windows Azure</a>

                </div>
            </div>
        </div>
        
    </body>
</html>
