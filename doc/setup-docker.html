<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>bcbio-nextgen-vm on Windows Azure : Setup Docker</title>
        <meta name="description" content="A brief documentation for bcbio-nextgen-vm on Windows Azure">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/docs-azure-bcbiovm/css/syntax.css">
        <link rel="stylesheet" href="/docs-azure-bcbiovm/css/main.css">
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <h4><a class="brand" href="/docs-azure-bcbiovm/">bcbio-nextgen-vm on Windows Azure</a>
    <small>A brief documentation for bcbio-nextgen-vm on Windows Azure</small>
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-2">
                        <ul class="nav nav-list">
    <li><a href="/docs-azure-bcbiovm/">Home</a></li>
    
        
        

        
            
                <li class="nav-header">Documentation</li>
            
            <li><a href="/docs-azure-bcbiovm/doc/environment-setup.html">Environment Setup</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/install-bcbio-nextgen-vm.html">Install bcbio-nextgen-vm</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/setup-docker.html">Setup Docker</a></li>
        
            
            <li><a href="/docs-azure-bcbiovm/doc/setup-azure-environment.html">Setup Windows Azure environment</a></li>
        
    
</ul>

                    </div>

                    <div id="content" class="col-sm-10">
                        <div class="page-header">
    <h2>Setup Docker
        
    </h2>
</div>

<p><strong>Note</strong>: this steps are not required if you intend to use one of the supported cloud providers.</p>

<h3 id="install-docker">Install docker</h3>

<p>Docker Engine is supported on Linux, Cloud, Windows, and OS X. Installation instructions are available for the following:</p>

<ul>
<li>On Linux

<ul>
<li><a href="https://docs.docker.com/engine/installation/archlinux/">Arch Linux</a></li>
<li><a href="https://docs.docker.com/engine/installation/centos/">CentOS</a></li>
<li><a href="https://docs.docker.com/engine/installation/cruxlinux/">CRUX Linux</a></li>
<li><a href="https://docs.docker.com/engine/installation/debian/">Debian</a></li>
<li><a href="https://docs.docker.com/engine/installation/fedora/">Fedora</a></li>
<li><a href="https://docs.docker.com/engine/installation/frugalware/">FrugalWare</a></li>
<li><a href="https://docs.docker.com/engine/installation/gentoolinux/">Gentoo</a></li>
<li><a href="https://docs.docker.com/engine/installation/oracle/">Oracle Linux</a></li>
<li><a href="https://docs.docker.com/engine/installation/rhel/">Red Hat Enterprise Linux</a></li>
<li><a href="https://docs.docker.com/engine/installation/SUSE/">openSUSE and SUSE Linux Enterprise</a></li>
<li><a href="https://docs.docker.com/engine/installation/ubuntulinux/">Ubuntu</a></li>
</ul></li>
<li>On OSX and Windows

<ul>
<li><a href="https://docs.docker.com/engine/installation/mac/">Mac OS X</a></li>
<li><a href="https://docs.docker.com/engine/installation/windows/">Windows</a></li>
</ul></li>
</ul>

<p><strong>Note</strong>: If your linux distribution is not listed above, donâ€™t give up yet. To try out Docker on a distribution that is not listed above, go here: <a href="https://docs.docker.com/engine/installation/binaries/">Installation from binaries</a>.</p>

<h3 id="setup-docker-groups">Setup docker groups</h3>

<p>Setup a docker group to provide the ability to run Docker without being root. Some installations, like Debian/Ubuntu packages do this automatically. You&#39;ll also want to add the trusted user who will be managing and testing docker images to this group:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>sudo groupadd docker
~ <span class="nv">$ </span>sudo service docker restart
~ <span class="nv">$ </span>sudo gpasswd -a <span class="k">${</span><span class="nv">USERNAME</span><span class="k">}</span> docker
~ <span class="nv">$ </span>newgrp docker
</code></pre></div>
<p>Ensure the driver script is setgid to the docker group. This allows users to run bcbio-nextgen without needing to be in the docker group or have root access. To avoid security issues, bcbio_vm.py sanitizes input arguments and runs the internal docker process as the calling user using a small wrapper script so it will only have permissions available to that user:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>sudo chgrp docker /usr/local/bin/bcbio_vm.py
~ <span class="nv">$ </span>sudo chmod g+s /usr/local/bin/bcbio_vm.py
</code></pre></div>
<h3 id="get-bcbio-bcbio-docker-image">Get bcbio/bcbio docker image</h3>

<p>Install the current bcbio docker image into your local repository by hand with:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>docker pull bcbio/bcbio
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">Using default tag: latest
latest: Pulling from bcbio/bcbio
78f8b74a3cfc: Pull complete 
77a2d9ee7d3f: Pull complete 
Digest: sha256:8e4a8372c2846607e4c32c33b08035340b7c2a2e54463ec06ac698ce5af27595
Status: Downloaded newer image for bcbio/bcbio:latest
</code></pre></div>
<p>The installer does this automatically, but this is useful if you want to work with the bcbio-nextgen docker image independently from the wrapper.</p>

<h3 id="setup-the-datadir">Setup the <code>datadir</code></h3>

<p>Create the <code>datadir</code>:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>mkdir -p ~/install/bcbio-vm/data
~ <span class="nv">$ </span><span class="nb">cd</span> ~/install/bcbio-vm/data
~ <span class="nv">$ </span>ln -s /usr/local/share/bcbio_nextgen/genomes
~ <span class="nv">$ </span>ln -s /usr/local/share/gemini/data gemini_data
</code></pre></div>
<p>Create the <code>datadir</code> using bcbiovm client application: </p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>bcbiovm.py azure prepare datadir --path ~/install/bcbio-vm/data
</code></pre></div>
<p>Update the default value for <code>datadir</code>:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>bcbio_vm.py --datadir<span class="o">=</span>~/install/bcbio-vm/data saveconfig
</code></pre></div>
<p>The output:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">[DEBUG]: Updating `datadir` value with `/home/alex/install/bcbio-vm/data`
[INFO]:  Writing the config file to `/home/alex/.config/bcbio-nextgen/bcbio-docker-config.yaml`.
[INFO]:  Execution of command `SaveConfig` ends with success. (None)
</code></pre></div>
<h3 id="create-a-new-docker-image">Create a new docker image</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>bcbio_vm.py -v azure devel dockerbuild <span class="se">\</span>
    --buildingtype full <span class="se">\</span>
    --rundir /tmp/bcbio-nextgen <span class="se">\</span>
    --no-upload
</code></pre></div><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&lt;</span> <span class="n">PLAY</span> <span class="p">[</span><span class="n">Create</span> <span class="n">the</span> <span class="n">bcbio_vm</span> <span class="n">docker</span> <span class="n">image</span> <span class="n">locally</span><span class="p">]</span> <span class="o">&gt;</span>
 <span class="o">-------------------------------------------------</span>

 <span class="n">_________________</span>
<span class="o">&lt;</span> <span class="n">GATHERING</span> <span class="n">FACTS</span> <span class="o">&gt;</span>
 <span class="o">-----------------</span>
<span class="o">&lt;</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">&gt;</span> <span class="n">REMOTE_MODULE</span> <span class="n">setup</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>

 <span class="n">________________________________________________________</span>
<span class="o">&lt;</span> <span class="n">TASK</span><span class="p">:</span> <span class="n">bcbio_vm_build</span> <span class="o">|</span> <span class="n">Clone</span> <span class="n">bcbio</span><span class="o">-</span><span class="n">nextgen</span> <span class="kn">from</span> <span class="nn">GitHub</span> <span class="o">&gt;</span>
 <span class="o">--------------------------------------------------------</span>
<span class="o">&lt;</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">&gt;</span> <span class="n">REMOTE_MODULE</span> <span class="n">git</span> <span class="n">version</span><span class="o">=</span><span class="n">master</span>
                          <span class="n">dest</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bcbio</span><span class="o">-</span><span class="n">nextgen</span> 
                          <span class="n">repo</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">chapmanb</span><span class="o">/</span><span class="n">bcbio</span><span class="o">-</span><span class="n">nextgen</span><span class="o">.</span><span class="n">git</span>
<span class="n">changed</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>

 <span class="n">______________________________________________</span>
<span class="o">/</span> <span class="n">TASK</span><span class="p">:</span> <span class="n">bcbio_vm_build</span> <span class="o">|</span> <span class="n">set_fact</span>              \
\ <span class="n">image_name</span><span class="o">=</span><span class="n">chapmanb</span><span class="o">/</span><span class="n">bcbio</span><span class="o">-</span><span class="n">nextgen</span><span class="o">-</span><span class="n">devel</span><span class="o">-</span><span class="n">work</span> <span class="o">/</span>
 <span class="o">----------------------------------------------</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>

 <span class="n">_________________________________________</span>
<span class="o">/</span> <span class="n">TASK</span><span class="p">:</span> <span class="n">bcbio_vm_build</span> <span class="o">|</span> <span class="n">set_fact</span>         \
\ <span class="n">image_name</span><span class="o">=</span><span class="n">chapmanb</span><span class="o">/</span><span class="n">bcbio</span><span class="o">-</span><span class="n">nextgen</span><span class="o">-</span><span class="n">devel</span> <span class="o">/</span>
 <span class="o">-----------------------------------------</span>
<span class="n">skipping</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>

 <span class="n">____________________________________________________</span>
<span class="o">/</span> <span class="n">TASK</span><span class="p">:</span> <span class="n">bcbio_vm_build</span> <span class="o">|</span> <span class="n">Update</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">bcbio</span> <span class="n">docker</span> \
\ <span class="n">container</span>                                          <span class="o">/</span>
 <span class="o">----------------------------------------------------</span>
<span class="n">skipping</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>

 <span class="n">__________________________________________________________</span>
<span class="o">&lt;</span> <span class="n">TASK</span><span class="p">:</span> <span class="n">bcbio_vm_build</span> <span class="o">|</span> <span class="n">Build</span> <span class="n">full</span> <span class="n">bcbio</span> <span class="n">docker</span> <span class="n">container</span> <span class="o">&gt;</span>
 <span class="o">----------------------------------------------------------</span>
<span class="o">&lt;</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">&gt;</span> <span class="n">REMOTE_MODULE</span> <span class="n">async_status</span> <span class="n">jid</span><span class="o">=</span><span class="mf">432667395995.21107</span>
<span class="n">changed</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">job</span> <span class="mf">432667395995.21107</span><span class="o">&gt;</span> <span class="n">finished</span> <span class="n">on</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>

 <span class="n">__________________________________________</span>
<span class="o">/</span> <span class="n">TASK</span><span class="p">:</span> <span class="n">bcbio_vm_build</span> <span class="o">|</span> <span class="n">command</span> <span class="n">tail</span> <span class="o">-</span><span class="mi">100</span> \
\ <span class="o">/</span><span class="n">build</span><span class="o">.</span><span class="n">log</span>                  <span class="o">/</span>
 <span class="o">------------------------------------------</span>
<span class="o">&lt;</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">&gt;</span> <span class="n">REMOTE_MODULE</span> <span class="n">command</span> <span class="n">tail</span> <span class="o">-</span><span class="mi">100</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bcbio</span><span class="o">-</span><span class="n">nextgen</span><span class="o">/</span><span class="n">build</span><span class="o">.</span><span class="n">log</span>
<span class="n">changed</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>

 <span class="n">_____________________________________</span>
<span class="o">/</span> <span class="n">TASK</span><span class="p">:</span> <span class="n">bcbio_vm_build</span> <span class="o">|</span> <span class="n">debug</span>        \
\ <span class="n">var</span><span class="o">=</span><span class="n">bcbio_docker_debug</span><span class="o">.</span><span class="n">stdout_lines</span> <span class="o">/</span>
 <span class="o">-------------------------------------</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s">&quot;var&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;bcbio_docker_debug.stdout_lines&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s">&quot;Sending build context to Docker daemon 557.1 kB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 1.114 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 1.671 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 2.228 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 2.785 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 3.342 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 3.899 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 4.456 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 5.014 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 5.571 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 6.128 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 6.685 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 7.242 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 7.799 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 8.356 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 8.913 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  9.47 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 10.03 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 10.58 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 11.14 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  11.7 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 12.26 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 12.81 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 13.37 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 13.93 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 14.48 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 15.04 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  15.6 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 16.15 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 16.71 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 17.27 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 17.83 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 18.38 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 18.94 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  19.5 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 20.05 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 20.61 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 21.17 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 21.73 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 22.28 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 22.84 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  23.4 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 23.95 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 24.48 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 25.01 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 25.53 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 26.06 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  26.6 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 27.13 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 27.69 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 28.25 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  28.8 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 29.36 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 29.92 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 30.47 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 31.03 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 31.59 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 32.15 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  32.7 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 33.26 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 33.82 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 34.37 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 34.93 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 35.49 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 36.04 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  36.6 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 37.16 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 37.72 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 38.27 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 38.83 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 39.39 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 39.94 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  40.5 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 41.06 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 41.62 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 42.17 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 42.73 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 43.29 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 43.84 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon  44.4 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 44.96 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 45.51 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 46.07 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 46.63 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 46.93 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;Sending build context to Docker daemon 46.93 MB&quot;</span><span class="p">,</span>
            <span class="s">&quot;&quot;</span><span class="p">,</span>
            <span class="s">&quot;Step 1 : FROM stackbrew/ubuntu:14.04&quot;</span><span class="p">,</span>
            <span class="s">&quot; ---&gt; 1d073211c498&quot;</span><span class="p">,</span>
            <span class="s">&quot;Step 2 : MAINTAINER Brad Chapman </span><span class="se">\&quot;</span><span class="s">https://github.com/chapmanb</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="s">&quot; ---&gt; Using cache&quot;</span><span class="p">,</span>
            <span class="s">&quot; ---&gt; 78f8b74a3cfc&quot;</span><span class="p">,</span>
            <span class="s">&quot;Step 3 : RUN apt-get update &amp;&amp; apt-get install -y build-essential zlib1g-dev wget curl python-setuptools git &amp;&amp;     apt-get install -y openjdk-7-jdk openjdk-7-jre ruby libncurses5-dev libcurl4-openssl-dev libbz2-dev     unzip pigz bsdmainutils &amp;&amp;     mkdir -p /tmp/fuse-hack &amp;&amp; cd /tmp/fuse-hack &amp;&amp;     apt-get install libfuse2 &amp;&amp;     apt-get download fuse &amp;&amp;     dpkg-deb -x fuse_* . &amp;&amp;     dpkg-deb -e fuse_* &amp;&amp;     rm fuse_*.deb &amp;&amp;     echo -en &#39;#!/bin/bash</span><span class="se">\\</span><span class="s">nexit 0</span><span class="se">\\</span><span class="s">n&#39; &gt; DEBIAN/postinst &amp;&amp;     dpkg-deb -b . /fuse.deb &amp;&amp;     dpkg -i /fuse.deb &amp;&amp;     rm -rf /tmp/fuse-hack &amp;&amp;     mkdir -p /tmp/bcbio-nextgen-install &amp;&amp; cd /tmp/bcbio-nextgen-install &amp;&amp;     wget --no-check-certificate       https://raw.github.com/chapmanb/bcbio-nextgen/master/scripts/bcbio_nextgen_install.py &amp;&amp;     python bcbio_nextgen_install.py /usr/local/share/bcbio-nextgen       --nodata -u development &amp;&amp;     git config --global url.https://github.com/.insteadOf git://github.com/ &amp;&amp;     /usr/local/share/bcbio-nextgen/anaconda/bin/bcbio_nextgen.py upgrade --sudo --tooldir=/usr/local --tools &amp;&amp;     /usr/local/share/bcbio-nextgen/anaconda/bin/bcbio_nextgen.py upgrade --isolate -u development --tools --toolplus data  &amp;&amp;     echo &#39;export PATH=/usr/local/bin:$PATH&#39; &gt;&gt; /etc/profile.d/bcbio.sh &amp;&amp;     wget --no-check-certificate -O createsetuser       https://raw.github.com/chapmanb/bcbio-nextgen-vm/master/scripts/createsetuser &amp;&amp;     chmod a+x createsetuser &amp;&amp; mv createsetuser /sbin &amp;&amp;     apt-get clean &amp;&amp;     rm -rf /var/lib/apt/lists/* /var/tmp/* &amp;&amp;     /usr/local/share/bcbio-nextgen/anaconda/bin/conda remove --yes qt &amp;&amp;     /usr/local/share/bcbio-nextgen/anaconda/bin/conda clean --yes --tarballs &amp;&amp;     rm -rf /usr/local/share/bcbio-nextgen/anaconda/pkgs/qt* &amp;&amp;     rm -rf $(brew --cache) &amp;&amp;     rm -rf /usr/local/.git &amp;&amp;     rm -rf /.cpanm &amp;&amp;     rm -rf /tmp/bcbio-nextgen-install &amp;&amp;     mkdir -p /mnt/biodata &amp;&amp;     mkdir -p /tmp/bcbio-nextgen &amp;&amp;     mv /usr/local/share/bcbio-nextgen/galaxy/bcbio_system.yaml /usr/local/share/bcbio-nextgen/config &amp;&amp;     rmdir /usr/local/share/bcbio-nextgen/galaxy &amp;&amp;     ln -s /mnt/biodata/galaxy /usr/local/share/bcbio-nextgen/galaxy &amp;&amp;     ln -s /mnt/biodata/gemini_data /usr/local/share/bcbio-nextgen/gemini_data &amp;&amp;     ln -s /mnt/biodata/genomes /usr/local/share/bcbio-nextgen/genomes &amp;&amp;     ln -s /mnt/biodata/liftOver /usr/local/share/bcbio-nextgen/liftOver &amp;&amp;     chmod a+rwx /usr/local/share/bcbio-nextgen &amp;&amp;     chmod a+rwx /usr/local/share/bcbio-nextgen/config &amp;&amp;     chmod a+rwx /usr/local/share/bcbio-nextgen/config/*.yaml &amp;&amp;     chmod a+rwx /usr/local/share/bcbio-nextgen/gemini-config.yaml &amp;&amp;     find /usr/local -perm /u+x -execdir chmod a+x {} </span><span class="se">\\</span><span class="s">; &amp;&amp;     find /usr/local -perm /u+w -execdir chmod a+w {} </span><span class="se">\\</span><span class="s">;&quot;</span><span class="p">,</span>
            <span class="s">&quot; ---&gt; Using cache&quot;</span><span class="p">,</span>
            <span class="s">&quot; ---&gt; 77a2d9ee7d3f&quot;</span><span class="p">,</span>
            <span class="s">&quot;Successfully built 77a2d9ee7d3f&quot;</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">_______________________</span>
<span class="o">/</span> <span class="n">TASK</span><span class="p">:</span> <span class="n">bcbio_vm_build</span> <span class="o">|</span> <span class="n">Create</span> <span class="n">gzipped</span> <span class="n">bcbio</span> <span class="n">docker</span> \
\ <span class="n">container</span>                                          <span class="o">/</span>
 <span class="o">----------------------------------------------------</span>
<span class="o">&lt;</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">&gt;</span> <span class="n">REMOTE_MODULE</span> <span class="n">command</span>
    <span class="n">chdir</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bcbio</span><span class="o">-</span><span class="n">nextgen</span>
    <span class="n">creates</span><span class="o">=</span><span class="n">bcbio</span><span class="o">-</span><span class="n">nextgen</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">gz</span>
    <span class="n">DID</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="n">chapmanb</span><span class="o">/</span><span class="n">bcbio</span><span class="o">-</span><span class="n">nextgen</span><span class="o">-</span><span class="n">devel</span><span class="o">-</span><span class="n">work</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span><span class="p">)</span>
    <span class="n">docker</span> <span class="n">export</span> <span class="err">$</span><span class="n">DID</span> <span class="o">|</span> <span class="n">gzip</span> <span class="o">-</span><span class="n">c</span> <span class="o">&gt;</span> <span class="n">bcbio</span><span class="o">-</span><span class="n">nextgen</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">gz</span>
    <span class="c">#USE_SHELL</span>
<span class="n">changed</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>
</code></pre></div>
<h3 id="create-and-upload-a-docker-image">Create and upload a docker image</h3>

<p>In order to create a new docker image and upload it to the default storage account we will use the following command:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">bcbio_vm.py azure devel dockerbuild <span class="se">\</span>
    --buildtype full <span class="se">\</span>
    --rundir /tmp/bcbio-nextgen <span class="se">\</span>
    --container bcbio-nextegen
</code></pre></div>
<p>The output for the above command will look like:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">[DEBUG]: Creating docker image: /tmp/bcbio-nextgen/bcbio-nextgen-docker-image.gz
[DEBUG]: Setup the environment before playbook run.
[DEBUG]: Trying to run &#39;/home/alex/miniconda/envs/_test/share/bcbio-vm/ansible/bcbio_vm_docker_local.yml&#39; ansible playbook.
[DEBUG]: Playbook started playing: Create the bcbio_vm docker image locally
[DEBUG]: Playbook is setting up.
[DEBUG]: Playbook starting task &#39;bcbio_vm_build | Clone bcbio-nextgen from GitHub&#39;:False
[DEBUG]: Playbook starting task &#39;bcbio_vm_build | set_fact image_name=chapmanb/bcbio-nextgen-devel-work&#39;:False
[DEBUG]: Playbook starting task &#39;bcbio_vm_build | set_fact image_name=chapmanb/bcbio-nextgen-devel&#39;:False
[DEBUG]: Playbook starting task &#39;bcbio_vm_build | Update code in bcbio docker container&#39;:False
[DEBUG]: Playbook starting task &#39;bcbio_vm_build | Build full bcbio docker container&#39;:False
[DEBUG]: Playbook starting task u&#39;bcbio_vm_build | command tail -100 /build.log&#39;:False
[DEBUG]: Playbook starting task &#39;bcbio_vm_build | debug var=bcbio_docker_debug.stdout_lines&#39;:False
[DEBUG]: Playbook starting task &#39;bcbio_vm_build | Create gzipped bcbio docker container&#39;:False
[DEBUG]: Cleanup the environment after playbook run.
[DEBUG]: Playbook response: ([], {})
[INFO]: Uploading docker image /tmp/bcbio-nextgen/bcbio-nextgen-docker-image.gz ...
[INFO]: The docker image was successfully uploaded ! Image URL: https://bcbio.blob.core.windows.net/bcbio-nextegen/bcbio-nextgen-docker-image.gz 
</code></pre></div>
<p><img src="https://alexandrucoman.github.io/docs-azure-bcbiovm/assets/upload-docker-image.png" alt="Upload docker image"></p>

<p><strong>Note</strong>: In order to upload the image to a specific storage account the following arguments can be used:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">  -c CONTAINER, --container CONTAINER
                        The container name where to upload the gzipped docker
                        image to
  -s STORAGE_ACCOUNT, --storage-account STORAGE_ACCOUNT
                        The storage account name. All access to Azure Storage
                        is done through a storage account.
  -k ACCESS_KEY, --access-key ACCESS_KEY
                        The key required to access the storage account.
</code></pre></div>
<h3 id="upgrade-docker-image">Upgrade docker image</h3>

<p>bcbio-nextgen-vm enables easy updates of the wrapper code, tools and data.</p>

<p>To update the wrapper code:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>git clone https://github.com/champmanb/bcbio-nextgen /tmp/bcbio-nextgen
~ <span class="nv">$ </span><span class="nb">cd</span> /tmp/bcbio-nexgen
~ <span class="nv">$ </span>bcbio_vm.py upgrade --wrapper --image bcbio/bcbio
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">[DEBUG]: The sample_config was not provided.
[INFO]: bcbio-nextgen-vm updated with latest wrapper scripts
[INFO]: Execution of command Upgrade ends with success. (None)
</code></pre></div>
<p>To update tools, with a download of the latest docker image:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>bcbio_vm.py upgrade --tools --image bcbio/bcbio
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">[DEBUG]: The sample_config was not provided.
[INFO]: Retrieving bcbio-nextgen docker image with code and tools
    [DEBUG]: bcbio-nextgen: Running in docker container: bb0fa025fb47b22ecfb617d34acd4d7b4ae7e6e4eaf18a18ca2ea988c237ac39
    [DEBUG]: bcbio-nextgen-commands: docker attach --no-stdin bb0fa025fb47b22ecfb617d34acd4d7b4ae7e6e4eaf18a18ca2ea988c237ac39
    [DEBUG]: bcbio-nextgen-stdout: Upgrade completed successfully.
[WARNING]: Stopping docker container
[INFO]: bcbio-nextgen-vm updated with latest bcbio-nextgen code and third party tools
[INFO]: Execution of command Upgrade ends with success. (None)
</code></pre></div>
<p>To update the associated data files:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>bcbio_vm.py upgrade --data --image bcbio/bcbio --genomes GRCh37
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">[DEBUG]: The sample_config was not provided.

DEBUG: bcbio-nextgen: Running in docker container: c3b1385c2c0bee74296d1f83d4a07e652c72225c2b9c0d27b0d15bf88d95351e
DEBUG: bcbio-nextgen-commands: docker attach --no-stdin c3b1385c2c0bee74296d1f83d4a07e652c72225c2b9c0d27b0d15bf88d95351e
Cloning into &#39;cloudbiolinux&#39;...
INFO: &lt;cloudbio.flavor.Flavor instance at 0x7fbbb9cf74d0&gt;
INFO: This is a ngs_pipeline_minimal flavor
INFO: Reading default fabricrc.txt
DBG [config.py]: Using config file /home/alex/tmpbcbio-install/cloudbiolinux/cloudbio/../config/fabricrc.txt
INFO: Distribution __auto__
INFO: Get local environment
INFO: Ubuntu setup
DBG [distribution.py]: Debian-shared setup
DBG [distribution.py]: Source=trusty
DBG [distribution.py]: NixPkgs: Ignored
INFO: Now, testing connection to host...
INFO: Connection to host appears to work!
DBG [utils.py]: Expand paths
INFO: List of genomes to get (from the config file at &#39;{&#39;install_liftover&#39;: False, &#39;genome_indexes&#39;: [&#39;rtg&#39;], &#39;genomes&#39;: [{&#39;rnaseq&#39;: True, &#39;name&#39;: &#39;Human (GRCh37)&#39;, &#39;dbsnp&#39;: True, &#39;validation&#39;: [&#39;giab-NA12878&#39;, &#39;dream-syn3&#39;, &#39;dream-syn4&#39;], &#39;annotations&#39;: [&#39;battenberg&#39;, &#39;GA4GH_problem_regions&#39;, &#39;MIG&#39;, &#39;prioritize&#39;], &#39;dbkey&#39;: &#39;GRCh37&#39;}], &#39;install_uniref&#39;: False}&#39;): Human (GRCh37)

--2015-11-12 15:12:02--  https://s3.amazonaws.com/biodata/annotation/GRCh37-rnaseq-2014-07-14.tar.xz

Resolving s3.amazonaws.com (s3.amazonaws.com)... 54.231.98.179
Connecting to s3.amazonaws.com (s3.amazonaws.com)|54.231.98.179|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 544869372 (520M) [binary/octet-stream]
Saving to: &#39;GRCh37-rnaseq-2014-07-14.tar.xz&#39;

     0K .......... .......... .......... .......... ..........  0% 82.9K 1h46m
    50K .......... .......... .......... .......... ..........  0%  122K 89m46s
   100K .......... .......... .......... .......... ..........  0%  335K 68m40s
   150K .......... .......... .......... .......... ..........  0%  191K 63m6s
   200K .......... .......... .......... .......... ..........  0%  244K 57m44s
   250K .......... .......... .......... .......... ..........  0%  243K 54m12s
   300K .......... .......... .......... .......... ..........  0%  245K 51m37s
   350K .......... .......... .......... .......... ..........  0%  244K 49m42s

...

[DEBUG]: bcbio-nextgen-stdout: Upgrade completed successfully.
[WARNING]: Stopping docker container
[INFO]: bcbio-nextgen-vm updated with latest biological data
[INFO]: Execution of command Upgrade ends with success. (None)
</code></pre></div>

                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/alexandrucoman/docs-azure-bcbiovm">bcbio-nextgen-vm on Windows Azure</a>

                </div>
            </div>
        </div>
        
    </body>
</html>
